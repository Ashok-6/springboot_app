package com.pg.user.service;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.time.format.DateTimeFormatter;

import org.springframework.stereotype.Service;

import com.itextpdf.text.Chunk;
import com.itextpdf.text.Document;
import com.itextpdf.text.Element;
import com.itextpdf.text.Font;
import com.itextpdf.text.FontFactory;
import com.itextpdf.text.Paragraph;
import com.itextpdf.text.pdf.PdfWriter;
import com.pg.user.dto.PaymentDto;
import com.pg.user.entity.Invoice;
import com.pg.user.repository.InvoiceRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class InvoiceServiceImpl implements InvoiceService {

    private final InvoiceRepository invoiceRepository;

    @Override
    public ByteArrayInputStream generateInvoice(PaymentDto payment) {
        try {
            Document document = new Document();
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            PdfWriter.getInstance(document, out);
            document.open();

            Font titleFont = FontFactory.getFont(FontFactory.HELVETICA_BOLD, 18);
            Paragraph title = new Paragraph("PG Payment Invoice", titleFont);
            title.setAlignment(Element.ALIGN_CENTER);
            document.add(title);
            document.add(Chunk.NEWLINE);

            document.add(new Paragraph("Payment ID: " + payment.getPaymentId()));
            document.add(new Paragraph("User ID: " + payment.getUserId()));
            document.add(new Paragraph("Amount: ₹" + payment.getAmount()));
            document.add(new Paragraph("Method: " + payment.getPaymentMethod()));

            String formattedDate = payment.getPaymentDate() != null
                    ? payment.getPaymentDate().format(DateTimeFormatter.ofPattern("dd-MM-yyyy HH:mm"))
                    : "N/A";
            document.add(new Paragraph("Date: " + formattedDate));

            document.close();
            return new ByteArrayInputStream(out.toByteArray());

        } catch (Exception e) {
            throw new RuntimeException("Error generating invoice PDF", e);
        }
    }

    @Override
    public Invoice saveInvoice(Long paymentId, ByteArrayInputStream pdfStream, String fileName) {
        try {
            byte[] pdfBytes = pdfStream.readAllBytes();

            // ✅ Check if invoice already exists for this paymentId
            Invoice existing = invoiceRepository.findByPaymentId(paymentId);
            if (existing != null) {
                return existing; // return existing invoice instead of creating new
            }

            Invoice invoice = Invoice.builder()
                    .paymentId(paymentId)
                    .fileName(fileName)
                    .pdfData(pdfBytes)
                    .build();

            return invoiceRepository.save(invoice);
        } catch (Exception e) {
            throw new RuntimeException("Error saving invoice", e);
        }
    }

    @Override
    public Invoice getInvoiceByPaymentId(Long paymentId) {
        return invoiceRepository.findByPaymentId(paymentId);
    }
}
